generator client {
  provider = "prisma-client-js"
  output   = "../generated/prisma"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ============================================
// User Management
// ============================================

model User {
  id          String   @id @default(cuid())
  telegramId  BigInt   @unique
  username    String?
  displayName String?
  language    String   @default("en")
  isActive    Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  channels              Channel[]
  authCodes             AuthCode[]
  notificationPreferences NotificationPreference?

  @@index([telegramId])
}

model AuthCode {
  id        String   @id @default(cuid())
  code      String   @unique
  expiresAt DateTime
  used      Boolean  @default(false)
  userId    String?
  user      User?    @relation(fields: [userId], references: [id], onDelete: SetNull)
  createdAt DateTime @default(now())

  @@index([code])
  @@index([expiresAt])
}

model NotificationPreference {
  id                  String  @id @default(cuid())
  userId              String  @unique
  user                User    @relation(fields: [userId], references: [id], onDelete: Cascade)
  publishSuccess      Boolean @default(true)
  publishFailure      Boolean @default(true)
  scrapingComplete    Boolean @default(true)
  scheduledReminder   Boolean @default(true)
  autoPostReview      Boolean @default(true)

  @@index([userId])
}

// ============================================
// Channel Management
// ============================================

model Channel {
  id               String   @id @default(cuid())
  userId           String
  user             User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  telegramId       BigInt   @unique
  username         String?
  title            String
  niche            String?
  tone             String   @default("professional")
  language         String   @default("en")
  hashtags         String[] @default([])

  // SVG Style Configuration
  svgEnabled         Boolean  @default(false)
  svgStylePrompt     String?
  svgThemeColor      String   @default("#3B82F6")
  svgTextColor       String   @default("#1F2937")
  svgBackgroundStyle String   @default("solid")  // "solid", "gradient", "transparent"
  svgFontStyle       String   @default("modern") // "modern", "classic", "playful", "technical"

  isActive         Boolean  @default(true)
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt

  posts           Post[]
  contentSources  ContentSource[]
  autoPostConfig  AutoPostConfig?
  contentPlans    ContentPlan[]

  @@index([userId])
  @@index([telegramId])
}

model ContentSource {
  id               String            @id @default(cuid())
  channelId        String
  channel          Channel           @relation(fields: [channelId], references: [id], onDelete: Cascade)
  sourceType       ContentSourceType @default(telegram)

  // Telegram source fields (nullable for document sources)
  telegramUsername String?
  telegramId       BigInt?

  // Document source fields
  documentName     String?
  documentUrl      String?           // MinIO path
  documentMimeType String?
  documentSize     Int?
  chunkingPrompt   String?           // Custom AI prompt for document chunking

  // Web page source fields
  webpageUrl       String?           // URL to fetch
  webpageTitle     String?           // Extracted page title
  webpageDomain    String?           // Domain for display
  webpageError     String?           // Last fetch error (if any)
  skipChunking     Boolean @default(false) // If true, keep whole article as single source

  isActive         Boolean  @default(true)
  lastScrapedAt    DateTime?
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt

  // Scrape settings (for telegram sources)
  maxScrapePosts    Int      @default(10) // Max posts to scrape per update (1-50)

  // Auto-scrape settings (for telegram sources)
  autoScrapeEnabled Boolean  @default(false)
  scrapeInterval    String?  // "hourly", "daily", "weekly"
  scrapeJobId       String?  // BullMQ job ID for the repeatable job

  scrapedContent      ScrapedContent[]
  scrapeLogs          ScrapeLog[]
  contentPlanSources  ContentPlanSource[]

  @@unique([channelId, telegramUsername])
  @@index([channelId])
  @@index([autoScrapeEnabled])
  @@index([sourceType])
}

model ScrapedContent {
  id                String   @id @default(cuid())
  sourceId          String
  source            ContentSource @relation(fields: [sourceId], references: [id], onDelete: Cascade)

  // Telegram content fields (nullable for document chunks)
  telegramMessageId BigInt?
  telegramGroupedId String?  // For media albums (multiple images in one post)

  // Document chunk fields
  chunkIndex        Int?           // Order within document
  sectionTitle      String?        // Extracted section heading

  text              String?
  mediaUrls         String[] @default([])
  views             Int      @default(0)
  forwards          Int      @default(0)
  reactions         Int      @default(0)
  scrapedAt         DateTime @default(now())
  usedForGeneration Boolean  @default(false)

  mediaFiles        MediaFile[]
  imageAnalysis     ImageAnalysis?

  @@unique([sourceId, telegramMessageId])
  @@unique([sourceId, chunkIndex])
  @@index([sourceId])
  @@index([scrapedAt])
}

model ImageAnalysis {
  id               String   @id @default(cuid())
  scrapedContentId String   @unique
  scrapedContent   ScrapedContent @relation(fields: [scrapedContentId], references: [id], onDelete: Cascade)
  subject          String?
  style            String?
  colors           String[] @default([])
  composition      String?
  textOverlays     String?
  mood             String?
  generatedPrompt  String?
  analyzedAt       DateTime @default(now())

  @@index([scrapedContentId])
}

model ScrapeLog {
  id          String   @id @default(cuid())
  sourceId    String
  source      ContentSource @relation(fields: [sourceId], references: [id], onDelete: Cascade)
  status      String   // pending, running, completed, failed
  postsFound  Int      @default(0)
  newPosts    Int      @default(0)
  error       String?
  startedAt   DateTime?
  completedAt DateTime?
  createdAt   DateTime @default(now())

  @@index([sourceId])
  @@index([createdAt])
}

// ============================================
// Post Management
// ============================================

enum PostStatus {
  draft
  scheduled
  pending_review
  publishing
  published
  failed
}

enum PostGenerationType {
  manual
  from_prompt
  from_scraped
  from_research
  auto_research
  auto_scraped
}

enum ContentSourceType {
  telegram
  document
  webpage
}

model Post {
  id                 String             @id @default(cuid())
  channelId          String
  channel            Channel            @relation(fields: [channelId], references: [id], onDelete: Cascade)
  contentPlanId      String?
  contentPlan        ContentPlan?       @relation(fields: [contentPlanId], references: [id], onDelete: SetNull)
  content            String
  status             PostStatus         @default(draft)
  generationType     PostGenerationType @default(manual)
  generationPrompt   String?
  scheduledAt        DateTime?
  publishedAt        DateTime?
  telegramMessageId  BigInt?
  errorMessage       String?
  retryCount         Int                @default(0)
  isAutoGenerated    Boolean            @default(false)
  createdAt          DateTime           @default(now())
  updatedAt          DateTime           @updatedAt

  mediaFiles         MediaFile[]
  pendingReview      PendingReview?

  @@index([channelId])
  @@index([contentPlanId])
  @@index([status])
  @@index([scheduledAt])
}

model PendingReview {
  id                String   @id @default(cuid())
  postId            String   @unique
  post              Post     @relation(fields: [postId], references: [id], onDelete: Cascade)
  telegramMessageId BigInt?
  expiresAt         DateTime
  feedback          String?
  createdAt         DateTime @default(now())

  @@index([postId])
  @@index([expiresAt])
}

model MediaFile {
  id               String          @id @default(cuid())
  postId           String?
  post             Post?           @relation(fields: [postId], references: [id], onDelete: SetNull)
  scrapedContentId String?
  scrapedContent   ScrapedContent? @relation(fields: [scrapedContentId], references: [id], onDelete: SetNull)
  url              String
  type             String
  filename         String
  size             Int?
  mimeType         String?
  isGenerated      Boolean         @default(false)
  createdAt        DateTime        @default(now())

  @@index([postId])
  @@index([scrapedContentId])
}

// ============================================
// Auto-Posting Configuration
// ============================================

enum AutoPostSourceMode {
  research
  scraped
  both
}

enum AutoPostPublishMode {
  auto_publish
  review_first
  scheduled
}

model AutoPostConfig {
  id              String              @id @default(cuid())
  channelId       String              @unique
  channel         Channel             @relation(fields: [channelId], references: [id], onDelete: Cascade)
  isEnabled       Boolean             @default(false)
  sourceMode      AutoPostSourceMode  @default(research)
  publishMode     AutoPostPublishMode @default(review_first)
  cronSchedule    String              @default("0 9 * * *")
  researchTopics  String[]            @default([])
  minInterval     Int                 @default(60)
  dailyLimit      Int                 @default(5)
  weeklyLimit     Int                 @default(30)
  createdAt       DateTime            @default(now())
  updatedAt       DateTime            @updatedAt

  autoPostLogs    AutoPostLog[]

  @@index([channelId])
  @@index([isEnabled])
}

model AutoPostLog {
  id             String         @id @default(cuid())
  configId       String
  config         AutoPostConfig @relation(fields: [configId], references: [id], onDelete: Cascade)
  sourceType     String
  sourceRef      String?
  postId         String?
  status         String
  errorMessage   String?
  createdAt      DateTime       @default(now())

  @@index([configId])
  @@index([createdAt])
}

// ============================================
// Content Plans
// ============================================

enum ContentPlanPublishMode {
  auto_publish
  review_first
  draft_only
}

enum ContentSelectionStrategy {
  recent
  random
}

model ContentPlan {
  id                String                  @id @default(cuid())
  channelId         String
  channel           Channel                 @relation(fields: [channelId], references: [id], onDelete: Cascade)

  name              String
  promptTemplate    String
  isEnabled         Boolean                 @default(true)

  // Schedule (cron pattern)
  cronSchedule      String                  @default("0 9 * * *")
  timezone          String                  @default("UTC")

  // Publishing
  publishMode       ContentPlanPublishMode  @default(review_first)

  // Content selection
  selectionStrategy ContentSelectionStrategy @default(recent)
  selectionCount    Int                      @default(5)

  // Image generation
  imageEnabled      Boolean                 @default(true)
  imageType         String                  @default("svg")

  // SVG generation settings
  svgThemeColor     String                  @default("#3B82F6")
  svgBackgroundStyle String                 @default("gradient")
  svgFontStyle      String                  @default("modern")
  svgStylePrompt    String?

  // Tone/Style overrides (null = use channel defaults)
  toneOverride      String?
  languageOverride  String?

  // Memory settings
  lookbackDays      Int                     @default(30)
  lookbackPostCount Int                     @default(50)
  topicsToAvoid     String[]                @default([])

  createdAt         DateTime                @default(now())
  updatedAt         DateTime                @updatedAt

  contentSources    ContentPlanSource[]
  posts             Post[]

  @@index([channelId])
  @@index([isEnabled])
}

model ContentPlanSource {
  id              String        @id @default(cuid())
  contentPlanId   String
  contentPlan     ContentPlan   @relation(fields: [contentPlanId], references: [id], onDelete: Cascade)
  contentSourceId String
  contentSource   ContentSource @relation(fields: [contentSourceId], references: [id], onDelete: Cascade)

  @@unique([contentPlanId, contentSourceId])
  @@index([contentPlanId])
}

// ============================================
// Admin Management
// ============================================

model AdminUser {
  id           String   @id @default(cuid())
  username     String   @unique
  passwordHash String
  displayName  String?
  isActive     Boolean  @default(true)
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  auditLogs    AuditLog[]

  @@index([username])
}

model TelegramSession {
  id            String   @id @default(cuid())
  phone         String   @unique
  sessionString String
  isActive      Boolean  @default(true)
  lastUsedAt    DateTime?
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  @@index([isActive])
}

// ============================================
// Job & Audit Logging
// ============================================

enum JobStatus {
  pending
  running
  completed
  failed
  retrying
}

model JobLog {
  id         String    @id @default(cuid())
  jobId      String    @unique
  jobType    String
  status     JobStatus @default(pending)
  payload    Json?
  result     Json?
  error      String?
  attempts   Int       @default(0)
  startedAt  DateTime?
  completedAt DateTime?
  createdAt  DateTime  @default(now())

  @@index([jobType])
  @@index([status])
  @@index([createdAt])
}

model AuditLog {
  id        String   @id @default(cuid())
  adminId   String
  admin     AdminUser @relation(fields: [adminId], references: [id], onDelete: Cascade)
  action    String
  entityType String?
  entityId  String?
  details   Json?
  ipAddress String?
  createdAt DateTime @default(now())

  @@index([adminId])
  @@index([action])
  @@index([createdAt])
}
